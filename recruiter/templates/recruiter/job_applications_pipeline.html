{% extends "base.html" %}
{% load static %}
{% load recruiter_utils %}

{% block title %}Applications: {{ job.title }} · DevJobs{% endblock %}

{% block extra_head %}
<style>
.kanban-board {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  overflow-x: auto;
  padding-bottom: 1rem;
}

@media (max-width: 1200px) {
  .kanban-board {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .kanban-board {
    grid-template-columns: 1fr;
  }
}

.kanban-column {
  background: #fff;
  border-radius: 8px;
  padding: 1rem;
  min-height: 500px;
  border: 1px solid #dee2e6;
}

.kanban-column-header {
  font-weight: 600;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.application-card {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.75rem;
  cursor: move;
  transition: all 0.2s;
}

.application-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.application-card.dragging {
  opacity: 0.4;
  cursor: grabbing;
}

.kanban-column.drag-over {
  background: #e7f3ff;
  border: 2px solid #0d6efd;
  box-shadow: 0 0 10px rgba(13, 110, 253, 0.3);
}

.applications-container {
  min-height: 100px;
  transition: background-color 0.2s ease;
}

.applicant-name {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.applicant-date {
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 0.5rem;
}

.applicant-skills {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  margin-bottom: 0.5rem;
}

.skill-badge {
  background: #e9ecef;
  color: #495057;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
}

.status-dropdown {
  font-size: 0.875rem;
}

.column-count {
  background: #6c757d;
  color: white;
  border-radius: 12px;
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<div class="mb-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'recruiter:jobs' %}">My Job Postings</a></li>
      <li class="breadcrumb-item active" aria-current="page">Applications</li>
    </ol>
  </nav>
</div>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 m-0">{{ job.title }}</h1>
    <p class="text-muted mb-0">{{ job.company }} • {{ job.location }}</p>
  </div>
  <a href="{% url 'recruiter:jobs' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> Back to Jobs
  </a>
</div>

<div class="kanban-board">
  {% for status_value, status_label in status_choices %}
    <div class="kanban-column" data-status="{{ status_value }}">
      <div class="kanban-column-header">
        <span>{{ status_label }}</span>
        <span class="column-count">{{ applications_by_status|lookup:status_value|length }}</span>
      </div>

      <div class="applications-container" data-status="{{ status_value }}">
        {% for application in applications_by_status|lookup:status_value %}
          <div class="application-card"
               draggable="true"
               data-application-id="{{ application.id }}"
               data-status="{{ application.status }}">
            <div class="applicant-name">
              {{ application.applicant.get_full_name|default:application.applicant.username }}
            </div>
            <div class="applicant-date">
              Applied {{ application.created_at|date:"M d, Y" }}
            </div>

            {% if application.applicant.applicant.skills.all %}
              <div class="applicant-skills">
                {% for skill in application.applicant.applicant.skills.all|slice:":5" %}
                  <span class="skill-badge">{{ skill.skill_name }}</span>
                {% endfor %}
                {% if application.applicant.applicant.skills.all|length > 5 %}
                  <span class="skill-badge">+{{ application.applicant.applicant.skills.all|length|add:"-5" }}</span>
                {% endif %}
              </div>
            {% endif %}

            <select class="form-select form-select-sm status-dropdown" data-application-id="{{ application.id }}">
              {% for choice_value, choice_label in status_choices %}
                <option value="{{ choice_value }}" {% if choice_value == application.status %}selected{% endif %}>
                  {{ choice_label }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
// Get CSRF token for AJAX requests
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Drag and Drop functionality
let draggedElement = null;

// Helper to find the column for any drag event target
function getColumnFromEventTarget(target) {
  if (!target) return null;
  return target.classList.contains('kanban-column')
    ? target
    : target.closest('.kanban-column');
}

// Use event delegation to avoid duplicate listeners
document.addEventListener('DOMContentLoaded', function() {
  const kanbanBoard = document.querySelector('.kanban-board');

  // Drag start on cards
  kanbanBoard.addEventListener('dragstart', function(e) {
    if (e.target.classList.contains('application-card')) {
      draggedElement = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', e.target.dataset.applicationId);

      setTimeout(() => {
        e.target.style.opacity = '0.4';
      }, 0);
    }
  });

  // Drag end on cards
  kanbanBoard.addEventListener('dragend', function(e) {
    if (e.target.classList.contains('application-card')) {
      e.target.style.opacity = '1';
      e.target.classList.remove('dragging');

      document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
      });

      draggedElement = null;
    }
  });

  // Drag over - allow dropping anywhere in the column (not just the cards area)
  kanbanBoard.addEventListener('dragover', function(e) {
    const column = getColumnFromEventTarget(e.target);
    if (column) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      column.classList.add('drag-over');
      return false;
    }
  });

  // Drag enter on columns/cards to provide visual feedback
  kanbanBoard.addEventListener('dragenter', function(e) {
    const column = getColumnFromEventTarget(e.target);
    if (column) {
      e.preventDefault();

      document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
      });
      column.classList.add('drag-over');
    }
  });

  // Drag leave on containers
  kanbanBoard.addEventListener('dragleave', function(e) {
    const leavingColumn = e.target.closest('.kanban-column');
    const enteringColumn = e.relatedTarget?.closest('.kanban-column');

    if (leavingColumn && leavingColumn !== enteringColumn) {
      leavingColumn.classList.remove('drag-over');
    }
  });

  // Drop - allow dropping anywhere in the column
  kanbanBoard.addEventListener('drop', function(e) {
    const column = getColumnFromEventTarget(e.target);
    const container = column?.querySelector('.applications-container');

    if (column && container && draggedElement) {
      e.preventDefault();
      e.stopPropagation();

      const newStatus = container.dataset.status;
      const applicationId = draggedElement.dataset.applicationId;
      const oldStatus = draggedElement.dataset.status;

      document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
      });

      if (newStatus !== oldStatus) {
        updateApplicationStatus(applicationId, newStatus, draggedElement, container);
      }
    }
  });

  // Dropdown change handler using event delegation
  kanbanBoard.addEventListener('change', function(e) {
    if (e.target.classList.contains('status-dropdown')) {
      const applicationId = e.target.dataset.applicationId;
      const newStatus = e.target.value;
      const card = e.target.closest('.application-card');
      const targetColumn = document.querySelector(`.applications-container[data-status="${newStatus}"]`);

      updateApplicationStatus(applicationId, newStatus, card, targetColumn);
    }
  });
});

function updateApplicationStatus(applicationId, newStatus, cardElement, targetColumn) {
  cardElement.style.pointerEvents = 'none';
  cardElement.style.opacity = '0.6';

  fetch('{% url "recruiter:update_application_status" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrftoken
    },
    body: `application_id=${applicationId}&status=${newStatus}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      targetColumn.appendChild(cardElement);
      cardElement.dataset.status = newStatus;

      const dropdown = cardElement.querySelector('.status-dropdown');
      dropdown.value = newStatus;

      cardElement.style.pointerEvents = 'auto';
      cardElement.style.opacity = '1';

      updateColumnCounts();

      console.log('Application status updated successfully');
    } else {
      alert('Error: ' + data.error);
      const dropdown = cardElement.querySelector('.status-dropdown');
      dropdown.value = cardElement.dataset.status;

      cardElement.style.pointerEvents = 'auto';
      cardElement.style.opacity = '1';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while updating the application status');
    const dropdown = cardElement.querySelector('.status-dropdown');
    dropdown.value = cardElement.dataset.status;

    cardElement.style.pointerEvents = 'auto';
    cardElement.style.opacity = '1';
  });
}

function updateColumnCounts() {
  const allColumns = document.querySelectorAll('.applications-container');
  allColumns.forEach(column => {
    const count = column.querySelectorAll('.application-card').length;
    const badge = column.closest('.kanban-column').querySelector('.column-count');
    badge.textContent = count;
  });
}
</script>
{% endblock %}
