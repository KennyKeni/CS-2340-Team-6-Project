{% extends 'base.html' %}
{% load static %}

{% block title %}{{ template_data.title|default:"Job Listings · DevJobs" }}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Job Listings</h1>
        <div class="d-flex gap-2">
        </div>
      </div>


      <!-- Job Listings -->
      {% if jobs %}
        {% for job in jobs %}
        <div class="card mb-3 job-card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
            <h5 class="card-title">
              <a href="{% url 'job:job_detail' job.id %}" class="text-decoration-none">
                {{ job.title }}
              </a>
            </h5>
            <p class="card-text text-muted mb-2">
              <i class="bi bi-building"></i> {{ job.company }} 
              <span class="mx-2">•</span>
              <i class="bi bi-geo-alt"></i> {{ job.location }}
              <span class="mx-2">•</span>
              <span class="badge bg-secondary">{{ job.get_job_type_display }}</span>
              <span class="mx-2">•</span>
              <small class="text-muted">
                <i class="bi bi-clock"></i> Posted {{ job.created_at|timesince }} ago
              </small>
            </p>
            <p class="card-text">{{ job.description|truncatewords:30 }}</p>
            {% if job.required_skills.exists %}
              <div class="mb-2">
                <small class="text-muted">Required Skills:</small>
                <div class="d-flex flex-wrap gap-1">
                  {% for skill in job.required_skills.all|slice:":5" %}
                    <span class="badge bg-secondary">{{ skill.skill_name }}</span>
                  {% endfor %}
                  {% if job.required_skills.count > 5 %}
                    <span class="badge bg-light text-dark">+{{ job.required_skills.count|add:"-5" }} more</span>
                  {% endif %}
                </div>
              </div>
            {% endif %}
            {% if job.salary_min and job.salary_max %}
              <p class="text-success fw-semibold mb-0">
                Salary Range: ${{ job.salary_min|floatformat:0 }} - ${{ job.salary_max|floatformat:0 }} {{ job.salary_currency }}
              </p>
            {% endif %}
          </div>
          <div class="col-md-4 text-end">
            <div class="mb-2">
              <small class="text-muted">
                <i class="bi bi-clock"></i> Posted {{ job.created_at|timesince }} ago
              </small>
            </div>
            {% load applicant_utils %}
            {% if user.is_authenticated and user|is_applicant %}
              {% if job.id in applied_job_ids %}
                <button class="btn btn-success btn-sm" disabled>
                  <i class="bi bi-check-circle"></i> Applied
                </button>
              {% else %}
                <button class="btn btn-primary btn-sm apply-btn" 
                        data-job-id="{{ job.id }}" 
                        data-job-title="{{ job.title }}">
                  <i class="bi bi-send"></i> Apply Now
                </button>
              {% endif %}
            {% else %}
              <a href="{% url 'account:login' %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-box-arrow-in-right"></i> Login to Apply
              </a>
            {% endif %}
          </div>
        </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-briefcase display-1 text-muted"></i>
          <h3 class="mt-3">No jobs found</h3>
          <p class="text-muted">Try adjusting your search criteria.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Application Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Apply to Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="applicationForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="personalized_note" class="form-label">
              Personalized Note <span class="text-muted">(Optional)</span>
            </label>
            <textarea class="form-control" id="personalized_note" name="personalized_note" 
                      rows="4" placeholder="Add a personalized note to make your application stand out..."></textarea>
            <div class="form-text">
              This note will be sent to the recruiter along with your application.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitApplication">
          <i class="bi bi-send"></i> Submit Application
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const applyButtons = document.querySelectorAll('.apply-btn');
  const modal = new bootstrap.Modal(document.getElementById('applicationModal'));
  const form = document.getElementById('applicationForm');
  const submitBtn = document.getElementById('submitApplication');
  let currentJobId = null;

  applyButtons.forEach(button => {
    button.addEventListener('click', function() {
      currentJobId = this.dataset.jobId;
      const jobTitle = this.dataset.jobTitle;
      document.querySelector('.modal-title').textContent = `Apply to ${jobTitle}`;
      modal.show();
    });
  });

  submitBtn.addEventListener('click', function() {
    if (!currentJobId) return;

    const formData = new FormData(form);
    const data = {
      personalized_note: formData.get('personalized_note')
    };

    fetch(`/jobs/${currentJobId}/apply/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
          ${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);

        // Update button state
        const applyBtn = document.querySelector(`[data-job-id="${currentJobId}"]`);
        applyBtn.innerHTML = '<i class="bi bi-check-circle"></i> Applied';
        applyBtn.className = 'btn btn-success btn-sm';
        applyBtn.disabled = true;

        // Close modal
        modal.hide();
        form.reset();

        // Auto-remove alert
        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 5000);
      } else {
        alert('Error: ' + (data.error || 'Failed to submit application'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error submitting application. Please try again.');
    });
  });
});
</script>
{% endblock %}
