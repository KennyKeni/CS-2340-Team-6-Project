{% extends 'base.html' %}
{% load static %}

{% block title %}{{ job.title }} at {{ job.company }} · DevJobs{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
      <!-- Job Header -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h1 class="h3 mb-2">{{ job.title }}</h1>
              <p class="text-muted mb-3">
                <i class="bi bi-building"></i> {{ job.company }} 
                <span class="mx-2">•</span>
                <i class="bi bi-geo-alt"></i> {{ job.location }}
                <span class="mx-2">•</span>
                <span class="badge bg-primary">{{ job.get_job_type_display }}</span>
              </p>
              {% if job.salary_min and job.salary_max %}
                <p class="text-success fw-semibold mb-0">
                  Salary Range: ${{ job.salary_min|floatformat:0 }} - ${{ job.salary_max|floatformat:0 }} {{ job.salary_currency }}
                </p>
              {% endif %}
            </div>
            <div class="text-end">
              {% load applicant_utils %}
              {% if user.is_authenticated and user|is_applicant %}
                {% if has_applied %}
                  <button class="btn btn-success" disabled>
                    <i class="bi bi-check-circle"></i> Applied
                  </button>
                {% else %}
                  <button class="btn btn-primary btn-lg apply-btn" 
                          data-job-id="{{ job.id }}" 
                          data-job-title="{{ job.title }}">
                    <i class="bi bi-send"></i> Apply Now
                  </button>
                {% endif %}
              {% else %}
                <a href="{% url 'account:login' %}" class="btn btn-outline-primary btn-lg">
                  <i class="bi bi-box-arrow-in-right"></i> Login to Apply
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Job Location Map -->
      {% if job.latitude and job.longitude %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Office Location</h5>
        </div>
        <div class="card-body">
          <p class="mb-3">
            <i class="bi bi-pin-map"></i> 
            {{ job.street_address }}, {{ job.city }}, {{ job.state }} {{ job.zip_code }}
          </p>
          
          {# Show commute estimate for logged-in applicants with location #}
          {% load applicant_utils %}
          {% if user.is_authenticated and user|is_applicant and user.latitude and user.longitude %}
          <div class="alert alert-info mb-3">
            <i class="bi bi-car-front"></i> 
            <strong>Estimated Commute:</strong> 
            <span id="commuteInfo">Calculating...</span>
          </div>
          {% endif %}
          
          {% include "job/job_location_map.html" with job=job interactive=False height="300px" map_id="jobDetailMap" show_directions=False google_maps_api_key=google_maps_api_key %}
          
          <div class="mt-3 text-center">
            <a href="https://www.google.com/maps/dir/?api=1&destination={{ job.latitude }},{{ job.longitude }}" 
               target="_blank" 
               class="btn btn-primary">
              <i class="bi bi-signpost-2"></i> Get Directions
            </a>
          </div>
        </div>
      </div>
      {% elif job.street_address %}
      {# Graceful fallback when coordinates missing #}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Office Location</h5>
        </div>
        <div class="card-body">
          <p class="mb-0">
            <i class="bi bi-pin-map"></i> 
            {{ job.street_address }}, {{ job.city }}, {{ job.state }} {{ job.zip_code }}
          </p>
        </div>
      </div>
      {% endif %}

      <!-- Job Description -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Job Description</h5>
        </div>
        <div class="card-body">
          <div class="job-description">
            {{ job.description|linebreaks }}
          </div>
        </div>
      </div>

      <!-- Requirements -->
      {% if job.requirements %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Requirements</h5>
        </div>
        <div class="card-body">
          <div class="requirements">
            {{ job.requirements|linebreaks }}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Required Skills -->
      {% if job.required_skills.exists %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Required Skills</h5>
        </div>
        <div class="card-body">
          {% load applicant_utils %}
          {% if user.is_authenticated and user|is_applicant %}
            {% with applicant_skills=user.applicant.skills.all %}
              <div class="mb-3">
                <small class="text-muted">Skills matching your profile are highlighted in green:</small>
              </div>
              <div class="d-flex flex-wrap gap-2">
                {% for job_skill in job.required_skills.all %}
                  {% if applicant_skills|has_skill:job_skill.skill_name %}
                    <span class="badge bg-success fs-6">
                      ✓ {{ job_skill.skill_name }}
                      <small>({{ job_skill.get_importance_level_display }})</small>
                    </span>
                  {% else %}
                    <span class="badge bg-secondary fs-6">
                      {{ job_skill.skill_name }}
                      <small>({{ job_skill.get_importance_level_display }})</small>
                    </span>
                  {% endif %}
                {% endfor %}
              </div>
            {% endwith %}
          {% else %}
            <div class="d-flex flex-wrap gap-2">
              {% for job_skill in job.required_skills.all %}
                <span class="badge bg-secondary fs-6">
                  {{ job_skill.skill_name }}
                  <small>({{ job_skill.get_importance_level_display }})</small>
                </span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Benefits -->
      {% if job.benefits %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Benefits</h5>
        </div>
        <div class="card-body">
          <div class="benefits">
            {{ job.benefits|linebreaks }}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Job Details -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Job Details</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Company:</dt>
                <dd class="col-sm-8">{{ job.company }}</dd>
                
                <dt class="col-sm-4">Location:</dt>
                <dd class="col-sm-8">{{ job.location }}</dd>
                
                <dt class="col-sm-4">Job Type:</dt>
                <dd class="col-sm-8">{{ job.get_job_type_display }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Posted:</dt>
                <dd class="col-sm-8">{{ job.created_at|date:"F d, Y" }}</dd>
                
                {% if job.application_deadline %}
                <dt class="col-sm-4">Deadline:</dt>
                <dd class="col-sm-8">{{ job.application_deadline|date:"F d, Y" }}</dd>
                {% endif %}
                
                {% if job.salary_min and job.salary_max %}
                <dt class="col-sm-4">Salary Range:</dt>
                <dd class="col-sm-8">${{ job.salary_min|floatformat:0 }} - ${{ job.salary_max|floatformat:0 }} {{ job.salary_currency }}</dd>
                {% endif %}
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Application Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Apply to Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="applicationForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="personalized_note" class="form-label">
              Personalized Note <span class="text-muted">(Optional)</span>
            </label>
            <textarea class="form-control" id="personalized_note" name="personalized_note" 
                      rows="4" placeholder="Add a personalized note to make your application stand out..."></textarea>
            <div class="form-text">
              This note will be sent to the recruiter along with your application, make sure it's good!
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitApplication">
          <i class="bi bi-send"></i> Submit Application
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const applyButtons = document.querySelectorAll('.apply-btn');
  const modal = new bootstrap.Modal(document.getElementById('applicationModal'));
  const form = document.getElementById('applicationForm');
  const submitBtn = document.getElementById('submitApplication');
  let currentJobId = null;

  applyButtons.forEach(button => {
    button.addEventListener('click', function() {
      currentJobId = this.dataset.jobId;
      const jobTitle = this.dataset.jobTitle;
      document.querySelector('.modal-title').textContent = `Apply to ${jobTitle}`;
      modal.show();
    });
  });

  submitBtn.addEventListener('click', function() {
    if (!currentJobId) return;

    const formData = new FormData(form);
    const data = {
      personalized_note: formData.get('personalized_note')
    };

    fetch(`/jobs/${currentJobId}/apply/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
          ${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);

        // Update button state
        const applyBtn = document.querySelector(`[data-job-id="${currentJobId}"]`);
        applyBtn.innerHTML = '<i class="bi bi-check-circle"></i> Applied';
        applyBtn.className = 'btn btn-success';
        applyBtn.disabled = true;

        // Close modal
        modal.hide();
        form.reset();

        // Auto-remove alert
        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 5000);
      } else {
        alert('Error: ' + (data.error || 'Failed to submit application'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error submitting application. Please try again.');
    });
  });
});
</script>

{# Load Google Maps API before any map initialization #}
{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
{% endif %}

{# Calculate commute time for applicants #}
{% load applicant_utils %}
{% if user.is_authenticated and user|is_applicant and user.latitude and user.longitude and job.latitude and job.longitude %}
<script>
// Calculate commute time using Distance Matrix API
function calculateCommute() {
  if (typeof google === 'undefined' || !google.maps) {
    console.warn('Google Maps not loaded yet');
    return;
  }

  const service = new google.maps.DistanceMatrixService();
  const origin = new google.maps.LatLng({{ user.latitude }}, {{ user.longitude }});
  const destination = new google.maps.LatLng({{ job.latitude }}, {{ job.longitude }});

  service.getDistanceMatrix({
    origins: [origin],
    destinations: [destination],
    travelMode: '{{ user.preferred_commute_method|default:"DRIVING" }}',
    unitSystem: google.maps.UnitSystem.IMPERIAL,
  }, (response, status) => {
    if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
      const element = response.rows[0].elements[0];
      const distance = element.distance.text;
      const duration = element.duration.text;

      const commuteInfo = document.getElementById('commuteInfo');
      if (commuteInfo) {
        commuteInfo.innerHTML = `
          <strong>${duration}</strong> (${distance}) via {{ user.get_preferred_commute_method_display|default:"Driving" }}
        `;
      }
    } else {
      const commuteInfo = document.getElementById('commuteInfo');
      if (commuteInfo) {
        commuteInfo.textContent = 'Unable to calculate commute';
      }
    }
  });
}

// Wait for Google Maps to load
window.addEventListener('load', () => {
  if (typeof google !== 'undefined' && google.maps) {
    calculateCommute();
  } else {
    setTimeout(() => {
      if (typeof google !== 'undefined' && google.maps) {
        calculateCommute();
      }
    }, 1500);
  }
});
</script>
{% endif %}
{% endblock %}
